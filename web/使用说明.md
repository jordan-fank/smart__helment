# 智能头盔监控系统 - 使用说明

## 系统架构

```
STM32智能头盔 → ESP8266 → 华为云IoT → Python后端 → Web前端
```

## 功能特点

- ✅ 实时监控温度、湿度、烟雾浓度
- ✅ 历史数据曲线图（最近50个数据点）
- ✅ 符合苹果UI设计规范的界面
- ✅ WebSocket实时数据推送
- ✅ 响应式设计，支持移动端

## 安装步骤

### 1. 安装Python依赖

```bash
cd web
pip install -r requirements.txt
```

### 2. 配置后端

打开 `backend.py`，根据需要修改配置：

```python
# 使用模拟数据（用于测试）
USE_SIMULATED_DATA = True  # 设置为False使用真实MQTT数据

# 华为云MQTT配置（如果使用真实数据）
MQTT_BROKER = "你的华为云地址"
MQTT_PORT = 1883
```

**重要提示**：
- 设备侧账号只能发布数据，不能订阅
- 如果要接收真实数据，需要使用华为云应用侧账号
- 或者使用华为云的数据转发功能

### 3. 启动后端服务器

```bash
python backend.py
```

启动成功后会显示：

```
==================================================
智能头盔监控系统 - 后端服务器
==================================================
模拟数据模式: 开启
访问地址: http://localhost:5000
==================================================
```

### 4. 访问Web界面

打开浏览器访问：`http://localhost:5000`

## 数据说明

### 实时显示的数据

- **温度**：环境温度（°C）
  - 正常：< 32°C
  - 偏高：32-40°C
  - 超标：> 40°C

- **湿度**：环境湿度（%）
  - 正常：< 64%
  - 偏高：64-80%
  - 超标：> 80%

- **烟雾浓度**：空气中烟雾浓度（ppm）
  - 正常：< 80 ppm
  - 偏高：80-100 ppm
  - 超标：> 100 ppm

### 历史数据曲线

- 显示最近50个数据点
- 自动滚动更新
- 支持鼠标悬停查看详细数值

## 华为云物模型配置

如果要使用真实数据，需要在华为云IoT平台配置以下属性：

### 必需属性（环境监测）

```json
{
  "temp": {
    "type": "decimal",
    "unit": "°C",
    "description": "温度"
  },
  "humi": {
    "type": "decimal",
    "unit": "%",
    "description": "湿度"
  },
  "ppm": {
    "type": "decimal",
    "unit": "ppm",
    "description": "烟雾浓度"
  }
}
```

### 可选属性（健康监测）

```json
{
  "dis_hr": {
    "type": "int",
    "unit": "bpm",
    "description": "心率"
  },
  "dis_spo2": {
    "type": "int",
    "unit": "%",
    "description": "血氧"
  }
}
```

### 可选属性（姿态监测）

```json
{
  "Pitch": {
    "type": "decimal",
    "unit": "°",
    "description": "俯仰角"
  },
  "Roll": {
    "type": "decimal",
    "unit": "°",
    "description": "横滚角"
  },
  "Yaw": {
    "type": "decimal",
    "unit": "°",
    "description": "偏航角"
  }
}
```

### 可选属性（报警标志）

```json
{
  "fall_flag": {
    "type": "int",
    "description": "跌倒标志"
  },
  "collision_flag": {
    "type": "int",
    "description": "碰撞标志"
  },
  "heartrate_flag": {
    "type": "int",
    "description": "心率异常标志"
  },
  "spo2_flag": {
    "type": "int",
    "description": "血氧异常标志"
  },
  "temp_flag": {
    "type": "int",
    "description": "温度异常标志"
  },
  "mq2_flag": {
    "type": "int",
    "description": "烟雾异常标志"
  }
}
```

## 故障排查

### 问题1：标志位和欧拉角无法上传

**可能原因**：
1. 华为云物模型中没有定义这些属性
2. 属性名称大小写不匹配

**解决方案**：
1. 登录华为云IoT平台
2. 进入产品详情 → 模型定义
3. 添加上述可选属性
4. 确保属性名称完全一致（区分大小写）

### 问题2：Web界面无数据

**可能原因**：
1. 后端服务器未启动
2. 使用了真实MQTT但未配置应用侧账号

**解决方案**：
1. 检查后端是否正常运行
2. 设置 `USE_SIMULATED_DATA = True` 使用模拟数据测试
3. 检查浏览器控制台是否有错误信息

### 问题3：心率血氧测量不稳定

**已修复**：
- 移除了过于严格的数据清零逻辑
- 无效数据时保持上次有效值
- 避免频繁跳变

**调试方法**：
- 查看串口输出的调试信息：`[ESP] Body: HR=xx SpO2=xx`
- 确认传感器是否正常工作

## 界面预览

### 桌面端
- 三列卡片布局
- 大字号数值显示
- 平滑动画效果
- 渐变背景

### 移动端
- 自适应单列布局
- 触摸友好的交互
- 优化的字体大小

## 技术栈

### 后端
- Python 3.x
- Flask（Web框架）
- Flask-SocketIO（WebSocket）
- paho-mqtt（MQTT客户端）

### 前端
- HTML5 + CSS3
- Chart.js（图表库）
- Socket.IO（WebSocket客户端）
- 苹果UI设计规范

## 性能优化

- 数据缓冲区限制为1000个点
- 图表显示限制为50个点
- WebSocket推送频率：2秒/次
- 图表更新使用无动画模式

## 扩展功能

如需添加更多功能，可以修改：

1. **添加新的传感器数据**：
   - 在 `backend.py` 的 `latest_data` 中添加字段
   - 在 `index.html` 中添加显示卡片

2. **修改数据更新频率**：
   - 修改 `simulate_data()` 中的 `time.sleep(2)`

3. **调整图表样式**：
   - 修改 `index.html` 中的 Chart.js 配置

## 联系方式

如有问题，请查看：
- 串口调试输出
- 浏览器控制台
- 后端服务器日志

# 数据接收问题诊断指南

## 当前状态
- ✅ 后端服务器正常运行（http://localhost:5000）
- ✅ 前端页面正常连接（WebSocket已连接）
- ❌ 没有收到华为云转发的数据（没有POST /api/data请求）

## 排查步骤

### 步骤1：检查cpolar内网穿透是否运行

打开新的PowerShell窗口，运行：
```powershell
cpolar status
```

或者检查cpolar是否在运行：
```powershell
Get-Process cpolar
```

如果cpolar没有运行，启动它：
```powershell
cpolar http 5000
```

启动后会显示类似这样的信息：
```
Forwarding  https://xxxx.cpolar.cn -> http://localhost:5000
```

**记下这个外网地址**，例如：`https://abc123.cpolar.cn`

---

### 步骤2：测试cpolar转发是否正常

在另一个PowerShell窗口中测试：
```powershell
curl https://你的cpolar地址.cpolar.cn/api/status
```

如果返回JSON数据，说明cpolar转发正常。

---

### 步骤3：检查华为云数据转发规则

1. 登录华为云IoT平台：
   https://console.huaweicloud.com/iotdm/?region=cn-north-4

2. 进入：**规则引擎** → **数据转发**

3. 检查你的转发规则：
   - 规则状态：必须是"已启用"
   - 转发URL：必须是 `https://你的cpolar地址.cpolar.cn/api/data`
   - 方法：POST
   - 内容类型：application/json

4. 如果URL不正确，点击"编辑"修改为正确的cpolar地址

---

### 步骤4：检查设备是否在线并上报数据

1. 在华为云IoT平台，进入：**设备** → **所有设备**

2. 找到你的设备 `Helmet_01`，检查：
   - 设备状态：必须是"在线"（绿色）
   - 最后上线时间：应该是最近的时间

3. 点击设备名称，进入设备详情页

4. 查看"属性"标签页，检查：
   - 是否有最新的数据
   - 数据更新时间是否是最近的

5. 如果设备离线或数据不更新：
   - 检查STM32设备是否通电
   - 检查ESP8266是否连接到WiFi
   - 检查串口是否有错误信息

---

### 步骤5：手动测试数据接收

在PowerShell中手动发送测试数据：
```powershell
$body = @{
    notify_data = @{
        body = @{
            services = @(
                @{
                    properties = @{
                        temp = 25.5
                        humi = 60.0
                        ppm = 50.0
                        dis_hr = 75
                        dis_spo2 = 98
                    }
                }
            )
        }
    }
} | ConvertTo-Json -Depth 10

Invoke-WebRequest -Uri "http://localhost:5000/api/data" -Method POST -Body $body -ContentType "application/json"
```

如果后端收到数据，会显示：
```
[接收] 原始数据: {...}
[数据] #1 温度=25.5 心率=75 在线=True
```

前端页面也会立即显示这些数据。

---

## 常见问题

### Q1: cpolar地址经常变化怎么办？
A: 免费版cpolar每次重启地址会变。解决方案：
- 升级cpolar付费版获得固定域名
- 或者每次重启后更新华为云转发规则的URL

### Q2: 华为云数据转发有延迟吗？
A: 通常延迟在1-2秒内。如果超过10秒没有数据，检查转发规则是否启用。

### Q3: 如何查看华为云转发日志？
A: 在华为云IoT平台，进入：**规则引擎** → **数据转发** → 点击规则名称 → **执行日志**

### Q4: 后端显示"数据格式不正确"怎么办？
A: 这个问题已经修复。如果还出现，检查华为云转发的数据格式是否正确。

---

## 快速诊断命令

在PowerShell中依次运行：

```powershell
# 1. 检查后端是否运行
curl http://localhost:5000/api/status

# 2. 检查cpolar是否运行
Get-Process cpolar

# 3. 测试手动发送数据
$body = '{"notify_data":{"body":{"services":[{"properties":{"temp":25.5}}]}}}'
Invoke-WebRequest -Uri "http://localhost:5000/api/data" -Method POST -Body $body -ContentType "application/json"
```

---

## 下一步

根据排查结果：

1. **如果cpolar没有运行** → 启动cpolar并更新华为云转发URL
2. **如果设备离线** → 检查STM32设备和ESP8266连接
3. **如果转发规则未启用** → 在华为云控制台启用规则
4. **如果手动测试成功** → 说明后端正常，问题在华为云转发配置

完成排查后，告诉我结果，我会继续帮你解决问题。
